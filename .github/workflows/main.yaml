# This is based on
# <https://github.com/ongardie/cubicle/blob/b307fe9/.github/workflows/main.yaml>
# with Diego's permission.  The initial workflow YAML skeleton before that was
# based on
# <https://github.com/actions-rs/example/blob/master/.github/workflows/quickstart.yml>
# and
# <https://github.com/ramosbugs/oauth2-rs/blob/main/.github/workflows/main.yml>.
#
# GitHub Actions workflow syntax documentation is here:
# <https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions>.
name: CI

on:
  pull_request: {}
  push:
    branches:
    - main
  workflow_dispatch: {}

jobs:
  rust_ppc:
    name: Build PPC
    runs-on: ubuntu-20.04
    steps:
    - name: Check out sources
      uses: actions/checkout@v2
      with:
        submodules: recursive
        token: ${{ secrets.ACCESS_TOKEN }}

    - name: Free up some space on image
      # see https://github.com/actions/runner-images/issues/2840
      run: |
        sudo rm -rf /usr/share/dotnet
      shell: bash

    - name: Install latest nightly
      uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
        override: false
        components: rust-src

    - name: Install PowerPC cross-compile dependencies
      run: sudo apt install qemu qemu-user qemu-user-binfmt gcc-9-powerpc-linux-gnu

    - name: Cross Compile PowerPC
      run: ./build-ppc.sh

    - name: Run unit tests on PowerPC
      run: ./test-ppc.sh

  rust_x86:
    name: Build x86 + Demo
    runs-on: ubuntu-20.04
    steps:
    - name: Check out sources
      uses: actions/checkout@v2
      with:
        submodules: recursive
        token: ${{ secrets.ACCESS_TOKEN }}

    - name: Free up some space on image
      # see https://github.com/actions/runner-images/issues/2840
      run: |
        sudo rm -rf /usr/share/dotnet
      shell: bash

    - name: Install Rust stable toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable

    - name: Use Go cache
      uses: actions/cache@v3
      with:
        path: |
          ~/go/bin
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Use Go path
      # See https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#adding-a-system-path
      run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Install Bigtable tools
      run: |
        command -V emulator || go install cloud.google.com/go/bigtable/cmd/emulator@latest

    - name: Install Protobuf Compiler
      run: sudo apt install protobuf-compiler

    - name: Use Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: |
          .
          sdk

    - name: Run cargo build
      uses: actions-rs/cargo@v1
      with:
        command: build

    - name: Run demo
      run: |
        RUST_BACKTRACE=1 cargo run --bin demo_runner -- --demo target/debug/demo
      shell: bash

  swift_demo:
    name: Swift Demo
    runs-on: macOS-latest
    steps:
    - name: Check out sources
      uses: actions/checkout@v2
      with:
        submodules: recursive
        token: ${{ secrets.ACCESS_TOKEN }}

    - name: Free up some space on image
      # see https://github.com/actions/runner-images/issues/2840
      run: |
        sudo rm -rf /usr/share/dotnet
      shell: bash

    - name: Install Rust stable toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable

    - name: Use Go cache
      uses: actions/cache@v3
      with:
        path: |
          ~/go/bin
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Use Go path
      # See https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#adding-a-system-path
      run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Install Bigtable tools
      run: |
        rm /Users/runner/Library/Android/sdk/tools/emulator || true
        command -V emulator || go install cloud.google.com/go/bigtable/cmd/emulator@latest

    - name: Install Protobuf Compiler
      run: brew install protobuf

    - name: Use Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: |
          .
          sdk

    - name: Run cargo build
      uses: actions-rs/cargo@v1
      with:
        command: build

    - name: Build FFI
      run: cd sdk && ./swift/ffi.sh

    - name: Build Swift Demo
      run: cd sdk/swift/demo && swift build --verbose

    - name: Run demo
      run: |
        RUST_BACKTRACE=1 cargo run --bin demo_runner -- --demo sdk/swift/demo/.build/debug/demo
      shell: bash

  lint_and_test:
    name: Lint & Test
    runs-on: ubuntu-20.04
    steps:
    - name: Check out sources
      uses: actions/checkout@v2
      with:
        submodules: recursive
        token: ${{ secrets.ACCESS_TOKEN }}

    - name: Install Rust stable toolchain
      uses: actions-rs/toolchain@v1
      with:
        components: rustfmt, clippy
        override: 'true'
        profile: minimal
        toolchain: stable

    - name: Use Go cache
      uses: actions/cache@v3
      with:
        path: |
          ~/go/bin
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Use Go path
      # See https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#adding-a-system-path
      run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Install Bigtable tools
      run: |
        command -V emulator || go install cloud.google.com/go/bigtable/cmd/emulator@latest

    - name: Install Protobuf Compiler
      run: sudo apt install protobuf-compiler

    - name: Use Rust Cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: |
          .
          sdk

    - name: Run cargo test
      uses: actions-rs/cargo@v1
      with:
        args: --workspace --exclude 'entrust-*'
        command: test
      env:
        RUST_BACKTRACE: '1'

    - name: Run cargo fmt
      uses: actions-rs/cargo@v1
      with:
        args: --all -- --check
        command: fmt

    - name: Run clippy
      uses: actions-rs/cargo@v1
      with:
        args: --workspace --tests -- -D warnings
        command: clippy

    - name: Install cargo audit
      uses: actions-rs/cargo@v1
      with:
        args: cargo-audit
        command: install

    - name: Run cargo audit
      uses: actions-rs/cargo@v1
      with:
        command: audit
